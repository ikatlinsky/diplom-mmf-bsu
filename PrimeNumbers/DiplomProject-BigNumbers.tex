\section{Построение больших простых чисел}

\paragraph{} Существует довольно эффективный способ убедиться, что заданное число является составным, не разлагая это число на множители. 
Согласно малой теореме Ферма, если число \textit{n} простое, то для любого целого \textit{a}, не делящегося на \textit{n}, выполняется сравнение
\begin{equation}
 \textit{a\textsuperscript{ n-1} {$\equiv$} 1 (mod n)}.
\end{equation}
Если же при каком-то \textit{a} это сравнение нарушается, можно утверждать, что \textit{n} - составное. Вопрос только в том, как найти для составного \textit{n}
целое число \textit{a}, не удовлетворяющее (***). Можно, например, пытаться найти необходимое число \textit{a}, испытывая все целые числа подряд, 
начиная с \textit{2}. Или попробовать выбирать эти числа случайным образом на отрезке \textit{1 < a < n}.

  К сожалению, такой подход не всегда даёт то, что хотелось бы. Имеются составные числа \textit{n}, обладающие свойством (2.1.1) для любого целого
\textit{a} с условием \textit{(a, n) = 1}. Такие числа называются числами Кармайкла. Рассмотрим, например, число \textit{561 = 3{$\cdot$}11{$\cdot$}17}. 
Так как 560 делится на каждое из чисел 2, 10, 16, то с помощью малой теоремы Ферма легко проверить, что 561 есть число Кармайкла. 
Можно доказать, что любое из чисел Кармайкла имеет вид \textit{n = p\textsubscript{1} {$\cdot$} {$\dots$} {$\cdot$} p\textsubscript{r}, r {$\geq$} 3}, 
где все простые \textit{p\textsubscript{i}} различны, причем \textit{n - 1} делится на каждую разность \textit{p\textsubscript{i} - 1}. 
Лишь недавно, была решена проблема о бесконечности множества таких чисел.

  В 1976 г. Миллер предложил заменить проверку (***) проверкой несколько иного условия. Если \textit{n} - простое число, 
\textit{n - 1 = 2\textsuperscript{ s} t}, где \textit{t} нечётно, то согласно малой теореме Ферма для каждого \textit{a} с 
условием \textit{(a, n) = 1} хотя бы одна из скобок в произведении
\begin{equation}
 \textit{(a\textsuperscript{ t} - 1)(a\textsuperscript{ t} + 1)(a\textsuperscript{ 2 t} + 1){$\cdot$} {$\dots$} {$\cdot$}(a\textsuperscript{ 2\textsuperscript{ s - 1}t} + 1) = a\textsuperscript{ n - 1} - 1}
\end{equation}
делится на \textit{n}. Обращение этого свойства можно использовать, чтобы отличать составные числа от простых.

Пусть \textit{n} - нечётное составное число, \textit{n - 1 = 2\textsuperscript{s} t}, где \textit{t} нечётно. Назовем целое число \textit{a},
\textit{1 < a < n}, «хорошим» для \textit{n}, если нарушается одно из двух условий: 
\begin{enumerate}
 \item \textit{n} не делится на \textit{a};
 \item \textit{a\textsuperscript{ t} {$\equiv$} 1 (mod n)} или существует целое \textit{k}, 0 {$\leq$} k {$\leq$} s, такое, что
  \begin{equation}
      \textit{a\textsuperscript{ 2\textsuperscript{ k} t} {$\equiv$} -1 (mod n)}
  \end{equation}

\end{enumerate}
Из сказанного ранее следует, что для простого числа \textit{n} не существует хороших чисел \textit{a}. Если же \textit{n} составное число, 
то, как доказал Рабин, их существует не менее \textit{{$\dfrac{3}{4}$}(n - 1)}.


\subsection{Проверка большого числа на простоту}

\paragraph{} Перед описанием некоторых алгоритмов и тестов на простоту чисел введем определения и утверждения

  \begin{definition}    
  
      Пусть \textit{n} {$\in$} \textit{N} нечетное число и \textit{n – 1 = 2\textsuperscript{ s} t}, \textit{t} – нечетное,
    число \textit{a} {$\in$} \textit{N}, такое, что \textit{0 < a < n}, называется свидетелем 
    простоты числа \textit{n}, если выполнены 2 условия:

    \begin{enumerate}
      \item \textit{(a, n) = 1}
      \item Справедливо хотя бы одно {$\in$} сравнений \textit{a\textsuperscript{ t} {$\equiv$} 1 (mod n)}, 
  \textit{a\textsuperscript{ t} {$\equiv$} -1 (mod n)}, \textit{a\textsuperscript{ 2 t} {$\equiv$} -1(mod n)},
  {$\dots$}, \textit{a\textsuperscript{ t 2\textsuperscript{ s-1}} {$\equiv$} -1(mod n)}
    \end{enumerate}
  
  \end{definition}

  \begin{definition}    
  
      Составное число \textit{n} {$\in$} \textit{N} называется сильно псевдопростым по основанию \textit{a} 
    {$\in$} \textit{Z\textsubscript{ n}}, если число \textit{a} является свидетелем простоты числа \textit{n}.
    
  \end{definition}

  \begin{statement}   
  
      Пусть \textit{a}, \textit{n} {$\in$} \textit{N}, \textit{0 < a < n}, если число a не является свидетелем 
    простоты числа \textit{n}, то \textit{n} - составное.
    
  \end{statement}

\subsubsection{Тест на свидетельство простоты}

\paragraph{} Пусть даны 2 числа \textit{a}, \textit{n} {$\in$} \textit{N}, \textit{n} – нечетное, \textit{n - 1 = 2\textsuperscript{ s} t}, 
\textit{t} – нечетное, необходимо проверить, является ли число \textit{а} свидетелем простоты числа \textit{n}.

  \begin{enumerate}
   \item Если \textit{(a, n) {$\ge$} 1}, то \textit{а} не является свидетелем простоты числа \textit{n}, конец алгоритма
   \item Вычисляем \textit{a\textsuperscript{ t} (mod n)}, если \textit{a\textsuperscript{ t} {$\equiv$} {$\pm$}1(mod n)}, то \textit{а}
– свидетель простоты числа \textit{n}, конец алгоритма
   \item Последовательно для \textit{i=1, {$\dots$}, s - 1} вычисляем \textit{a\textsuperscript{ t 2\textsuperscript{ i}}(mod n)} и 
проверяем, если \textit{a\textsuperscript{ t 2\textsuperscript{ i}} {$\equiv$} n - 1 (mod n)}, то \textit{а} – 
свидетель простоты числа \textit{n}, иначе \textit{а} не является свидетелем простоты числа \textit{n}
  \end{enumerate}


\subsubsection{Тест Миллер-Рабина}

\paragraph{}Пусть дано нечетное \textit{n} {$\in$} \textit{N}, \textit{n - 1 = 2\textsuperscript{ s} t}, \textit{t} – нечетное. Необходимо выяснить 
с вероятностью \textit{1 – 4\textsuperscript{ -k}}, что \textit{n} – составное.
  
  \begin{enumerate}
   \item Пусть \textit{i = 1}
   \item Случайным образом выбираем натуральное число \textit{a}, \textit{1 < a < n}
   \item Если \textit{a} не является свидетелем простоты числа \textit{n}, то \textit{n} - составное, конец алгоритма
   \item Если \textit{i = k}, то \textit{n} — простое, конец алгоритма, иначе \textit{i = i + 1} и переходим к шагу 2
  \end{enumerate}

\subsubsection{Улучшенный тест Миллер-Рабина}

\paragraph{} Пусть число n {$\ge$} 2 – нечетно и \textit{n - 1 = 2\textsuperscript{ s} d}, где \textit{d} – нечетно. Для каждого числа \textit{a}
от 2 до \textit{r + 1} , где \textit{r} – число проверок в  тесте, выполним следующие действия:

  \begin{enumerate}
   \item Вычисляем \textit{x\textsubscript{0} = a\textsuperscript{ d}(mod n)}
   \item Проверяем условие \textit{x\textsubscript{0}} {$\in$} \textit{{1, n-1}}. Если оно выполнится, тогда \textit{a} – свидетель 
простоты. Перейдем к следующему \textit{a}.
   \item Иначе проверим, содержится ли число \textit{n - 1} в последовательности 
\textit{{x\textsubscript{1}, x\textsubscript{2}, {$\dots$}, x\textsubscript{s-1}}}, где каждый последующий \textit{x} 
вычисляется по формуле \textit{x\textsubscript{i+1}=x\textsubscript{i}\textsuperscript{ 2} (mod n)}
  \end{enumerate}
  
  Если ответ положительный, то \textit{a} – свидетель простоты. Перейдем к следующему \textit{a {$\leq$} r+1}. Иначе, найден свидетель 
непростоты \textit{n}. Завершаем тест с сообщением «число n – составное». Если после \textit{r} проверок окажется \textit{r} свидетелей
простоты, то заканчиваем тест с сообщением «n – вероятно простое».

  \begin{statement}

      Тест Миллера-Рабина определяет, что \textit{n} {$\in$} \textit{N} – простое с вероятностью
    \textit{1 - 4\textsuperscript{ -k}} менее, чем за \textit{8 k N} арифметических операций, где \textit{N = {$\log_{2}{n}$} +1 }
    
  \end{statement}

  \begin{example}    
  
      Пусть \textit{n = 1729} – число Кармайкла, разложим \textit{n - 1 = 2\textsuperscript{ 6} 3\textsuperscript{ 3}}. 
    Выполним тест Миллера–Рабина для \textit{a = 2}:
    
    \begin{enumerate}
    \item x\textsubscript{0} = 2\textsuperscript{ 27} (mod 1729) = 625 {$\ne$} 1, {$\ne$} n - 1
    \item x\textsubscript{1} = x\textsubscript{0}\textsuperscript{2} (mod 1729) = 645\textsuperscript{ 2} (mod 1729) = 1065
    \item x\textsubscript{2} = x\textsubscript{1}\textsuperscript{2} (mod 1729) = 1065\textsuperscript{ 2} (mod 1729) = 1
    \end{enumerate}
    
    Последующие элементы \textit{{x\textsubscript{i}}} для \textit{i = 3, 4, 5} равны 1, и последовательность 
  \textit{{x\textsubscript{1}, x\textsubscript{2}, {$\dots$}, x\textsubscript{s-1}}}, 
  не содержит \textit{n - 1}. Значит, 2 является свидетелем непростоты \textit{n}, и \textit{n = 1729} – составное число
  
  \end{example}

\subsection{Построение больших простых чисел}

\paragraph{} Большие простые числа можно строить сравнительно быстро. При этом можно обеспечить их случайное распределение в 
заданном диапазоне величин. Иначе система шифрования RSA теряла бы всякий практический смысл. Наиболее эффективным средством 
построения простых чисел является \textit{теорема Диемитко}. Рассмотрим ее, ее модификацию, а так же полезное следствие из этой теоремы.

  \begin{theorem}[Диемитко]
      Пусть \textit{n = q R + 1}, где \textit{q} - простое число, \textit{R} - четное, \textit{R < 4(q + 1)}. Если найдется a<n:
      
	\begin{enumerate}
	 \item a\textsuperscript{ n - 1} {$\equiv$} 1(mod n);
	 \item a\textsuperscript{ {$\frac{n - 1}{q}$}} {$\ncong$} 1(mod n); 
	\end{enumerate}
	
      то \textit{n} – простое число.
  \end{theorem}


  \begin{theorem}
  
      Пусть \textit{N, S} - нечётные натуральные числа, \textit{N - 1 = S R}, причем для каждого простого делителя \textit{q}  
  числа \textit{S} существует целое число \textit{a} такое, что

    \begin{equation}
      \textit{a\textsuperscript{ N - 1} {$\equiv$} (mod N), (a\textsuperscript{ {$\frac{N - 1}{q}$}} - 1, N) = 1}
    \end{equation}

  Тогда каждый простой делитель \textit{p} числа \textit{N} удовлетворяет сравнению

    \begin{equation}
      \textit{p {$\equiv$} 1(mod 2S)}
    \end{equation}  
  
  \end{theorem}
  
  \begin{cons} 
    Если выполнены условия теоремы (2.1.2) и \textit{R {$\le$} 4S + 2}, то \textit{N} - простое число. Действительно, пусть \textit{N}  
  равняется произведению не менее двух простых чисел. Каждое из них, согласно утверждению теоремы (2.1.1), не меньше, чем \textit{2S + 1}. Но тогда 

    \begin{equation}
      \textit{(2S + 1)\textsuperscript{ 2} {$ \le $} N = S R + 1 {$ \le $} 4S\textsuperscript{ 2} + 2S + 1.}
    \end{equation}

    Противоречие и доказывает следствие.
  \end{cons}
  
  \paragraph{} Полезно показать как, имея большое простое число \textit{S}, можно построить существенно большее простое число \textit{N}. 
  
    \begin{enumerate}
     \item Выберем для этого случайным образом чётное число \textit{R} на промежутке \textit{S {$\le$} R {$\le$} 4S + 2} и положим \textit{N = S R + 1} 
     \item Затем проверим число \textit{N} на отсутствие малых простых делителей, разделив его на малые простые числа
     \item Испытаем \textit{N} некоторое количество раз с помощью алгоритм, проверяющего число на простоту, на пример тест Миллера-Рабина 
     \item Если при этом выяснится, что \textit{N} - составное число, то переходим к шагу 1 
    \end{enumerate}

Если число \textit{N} выдержало все тесты на простоту, то появляется надежда на то, что \textit{N} - простое число, и следует попытаться 
доказать простоту с помощью \textit{теоремы Диемитко}. Для этого можно случайным образом выбирать число \textit{a, 1 < a < N},
и проверять для него выполнимость соотношений

  \begin{equation}
    \textit{a\textsuperscript{ N - 1} {$\equiv$} (mod N), (a\textsuperscript{ R} - 1, N) = 1}.
  \end{equation}
  
  Если при выбранном \textit{a} эти соотношения выполняются, то, согласно следствию из \textit{теоремы Диемитко}, можно 
утверждать, что число \textit{N} простое. Если же эти условия нарушаются, нужно выбрать другое значение \textit{a} и повторять 
эти операции до тех пор, пока такое число не будет обнаружено.

  Кроме описанного выше алгоритма, можно использовать алгоритм перехода от меньшего простого числа к большему на основе \textit{теоремы Диемитко},
  Итак, если имеем простое число \textit{q}, то, перебирая четные числа \textit{R}, строим числа \textit{n = q R + 1} и испытываем их на 
  простоту согласно теореме Диемитко, пока не получим простое число. По полученному числу можно построить еще одно простое число и так далее,
  пока не будет достигнут требуемый размер числа.
  
  \subsubsection{Алгоритм перехода от меньшего простого числа к большему}
    Вход: \textit{t} - требуемая размерность простого числа, \textit{q} – простое число: |\textit{q}|= \textit{{$\lceil \frac{t}{2} \rceil$}}
    Выход: \textit{p} - простое число требуемой размерности
    
      \begin{enumerate}
      \item Вычисляем \textit{{$N = \lceil \frac{2\textsuperscript{ t - 1}}{q} \rceil + \lceil \frac{2\textsuperscript{ t - 1} \xi}{q} \rceil$}}. 
      Если \textit{N} - нечетное, то \textit{N = N + 1}
      \item \textit{u = 0}
      \item Вычисляем \textit{p = (N + u)q + 1} - кандидат в простые
      \item Если \textit{p > 2\textsuperscript{ t}}, возвращаемся на шаг 1
      \item Если \textit{2\textsuperscript{ p - 1} {$\equiv$} 1(mod p)} и \textit{2\textsuperscript{ N+u} {$\ncong$} 1(mod p)}, то идем на Выход
      \item Вычисляем \textit{u = u + 2}. Возвращаемся на шаг 3
      \end{enumerate}
      
      \begin{example}
	Вход: \textit{t = 4}, \textit{q = 3 = [11]\textsubscript{2}}, Выход: \textit{p = 13 = [1011]\textsubscript{2}}
	
	  \begin{enumerate}
	   \item \textit{{$N = \lceil \frac{8}{3} \rceil + \lceil \frac{8 \times 0.1}{3} \rceil = 4$}}, \textit{4} - четное число
	   \item \textit{u = 0}
	   \item \textit{{$p = 4 \times 3 + 1 = 13$}}
	   \item \textit{13 < 2\textsuperscript{ 4} = 16}
	   \item \textit{2\textsuperscript{ 12}(mod 13) = 1, 2\textsuperscript{ 4}(mod 13) = 3}
	  \end{enumerate}  
	
      \end{example}


  Предположим, что построенное число \textit{N} действительно является простым. Зададимся вопросом, сколь долго придётся 
перебирать числа \textit{a}, пока не будет найдено такое, для которого будут выполнены условия (2.1.7). Заметим, что для простого числа \textit{N}
первое условие (2.1.7), согласно малой теореме Ферма, будет выполняться всегда. Те же числа \textit{a}, для которых нарушается второе 
условие (2.1.7), удовлетворяют сравнению

  \begin{equation}
   \textit{a\textsuperscript{ R} {$\equiv$} 1(mod N)}.
  \end{equation}

Как известно, уравнение \textit{x\textsuperscript{ R} = 1} в поле вычетов \textit{F\textsubscript{N}} имеет не более \textit{R} решений. 
Одно из них \textit{x = 1}. Поэтому на промежутке \textit{1 < a < N} имеется не более \textit{R - 1} чисел, для которых не выполняются 
условия (2.1.7). Это означает, что, выбирая случайным образом числа \textit{a} на промежутке \textit{1 < a < N}, при простом \textit{N}
можно с вероятностью большей, чем \textit{1 - O(S\textsuperscript{ -1})}, найти число \textit{a}, для которого будут выполнены условия 
теоремы (2.1.1), и тем доказать, что \textit{N} действительно является простым числом.

  Заметим, что построенное таким способом простое число \textit{N} будет удовлетворять неравенству \textit{N > S\textsuperscript{ 2}}, 
т. е. будет записываться вдвое большим количеством цифр, чем исходное простое число \textit{S}. Заменив теперь число \textit{S} на 
найденное простое число \textit{N} и повторив с этим новым \textit{S} все указанные выше действия, можно построить еще большее простое 
число.

\subsection{Практические рекомендации}

\paragraph{} Поскольку простые числа должны выбираться таким образом, чтобы факторизовать их произведение было вычислительно невозможно, 
рекомендуется брать их очень большими и одинаковой длины.

  Разность чисел \textit{p} и \textit{q} также не должна быть маленькой, поскольку в этом случае \textit{p} эквивалентно \textit{q} и,
следовательно, \textit{p} эквивалентно \textit{{$\sqrt{N}$}}. Таким образом, разложение \textit{N} может быть найдено простым делением 
на все числа порядка \textit{{$\sqrt{N}$}}.

  Числа \textit{p} и \textit{q} должны быть также "устойчивыми" простыми числами. Введем определение “устойчивого числа”:
  
    \begin{definition}   

      Число \textit{p} является устойчивым, если оно удовлетворяет 3 условиям:
	\begin{enumerate}
	 \item Значения \textit{p} и \textit{q} должны различаться по длине всего на несколько разрядов. Например,и \textit{p}, 
и \textit{q} должны попадать в диапазон от \textit{10\textsubscript{ 75}} до \textit{10\textsubscript{ 100}}
	 \item Как \textit{(p - 1)}, так и \textit{(q - 1)} должны содержать в своих разложениях достаточно большой простой множитель.
	 \item \textit{GCD(p - 1, p - 1)} должен быть достаточно малым.
	\end{enumerate}

    \end{definition}

  Эти условия не позволит успешно факторизовать \textit{N} \textit{({$\rho$} - 1)} методом Полларда, который позволяет быстро разложить 
число \textit{N} на множители, если его делитель \textit{p} имеет небольшие (скажем, меньше миллиона) простые делители, позволяет 
избежать \textit{({$\rho$} + 1)} метода Ульямса, позволяющего разложить \textit{N} при условии, что \textit{p + 1} имеет неболшие делители, 
позволит избежать метода безключевого чтения RSA (циклической атаки).

  Кроме того, было показано, что если \textit{e < n} и \textit{d < n\textsuperscript{ {$\frac{1}{4}$}}}, то \textit{d} можно определить достаточно
легко.
  
  Если \textit{p} выбирается случайно и имеет довольно большой размер, то, как правило, \textit{p - 1} и \textit{p + 1} будут иметь 
большие простые делители. Однако выбор устойчивых простых чисел не защищает систему от атаки алгоритмом факторизации на основе 
эллиптических кривых.

  Введем понятие эллиптические кривых.
  
    \begin{definition}
      Эллиптическая кривая над полем \textit{K} - это множество точек проективной плоскости над \textit{K}, удовлетворяющих уравнению
      
	\begin{equation}
	  \textit{y\textsuperscript{ 2} + a\textsubscript{1}xy + a\textsubscript{3}x - x\textsuperscript{ 3} + a\textsubscript{2}x\textsuperscript{ 2} - a\textsubscript{4}x + a\textsubscript{0}}
	\end{equation}
      
      вместе с точкой на бесконечности.    
    \end{definition}
    
  В качестве примера рассмотрим алгоритм факторизации Ленстры целых чисел.
  
  Пусть \textit{N} - составное число, для которого требуется найти наименьший делитель \textit{p}. Рассмотрим множество 
\textit{Z\textsubscript{n} = {0, 1, 2, {$\dots$}, n - 1}} как основное множество для координат точек эллиптической кривой 
\textit{EC(Z\textsubscript{n}) : y\textsuperscript{ 2} = x\textsuperscript{ 3} + ax + b}. В строгом математическом смысле эта кривая 
не будет эллиптической кривой (Ленстра назвал такую кривую псевдокривой), так как \textit{F} не является полем, и, значит, в нем не 
всегда выполнимы операции нахождения обратного элемента, необходимые для нахождения суммы точек кривой. Однако Ленстра заметил, 
что невозможность вычисления суммы двух точек \textit{P (x\textsubscript{1}, y\textsubscript{1})} и \textit{Q(x\textsubscript{2}, y\textsubscript{2})} означает,
что разность первых координат \textit{x\textsubscript{2} - x\textsubscript{1}} должны равняться 0 по модулю одного из делителей \textit{N}, 
тогда, вычисляя наибольший общий делитель \textit{GCD(n, \textsubscript{2} - x\textsubscript{1})}, мы легко найдем искомый делитель. 
Суть алгоритма Ленстры заключается в выборе на псевдокривой EC(Z\textsubscript{n}) произвольной базовой точки \textit{P\textsubscript{0}} 
и домножении ее на всевозможные простые числа и их степени пока не получим \textit{kP\textsubscript{0} {$\equiv$} {$\infty$}(mod p)}, 
где \textit{p} - один из делителей \textit{N}.
 
  Получить устойчивые простые числа можно следующим способом: генерируем большие простые числа \textit{s} и \textit{t}. Затем 
получаем такое число \textit{r}, что \textit{r - 1} делится на \textit{t} (для этого рассматриваем нечетные числа вида
\textit{kt + 1}, где \textit{k} - последовательные натуральные числа, и проверяем их на простоту, пока не найдем простое). 
Затем вычисляя 

  \begin{equation}
   \textit{p {$\equiv$} (sr - 1 - rs - 1)(mod rs) + xrs,}
  \end{equation}

где \textit{x} - некоторое целое число и проверяя \textit{p} на простоту, находим устойчивое простое число \textit{p}.
  
